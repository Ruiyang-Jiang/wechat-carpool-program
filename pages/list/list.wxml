<!-- é¡¶éƒ¨ Tab -->
<view class="tabs">
  <view class="tab {{currentView==='passenger'?'active':''}}" bindtap="gotoFindPassenger">æ‰¾ä¹˜å®¢</view>
  <view class="tab {{currentView==='driver'?'active':''}}"    bindtap="gotoFindDriver">æ‰¾å¸æœº</view>
</view>

<!-- é¡µé¢æç¤ºä¿¡æ¯ -->
<view class="page-tip">
  <view class="tip-icon">â„¹ï¸</view>
  <view class="tip-content">
    <view class="tip-text" wx:if="{{currentView==='passenger'}}">ç›®å‰æ˜¾ç¤ºä¸ºæœ€è¿‘ä¸€å‘¨çš„è½¦æ‰¾äºº</view>
    <view class="tip-text" wx:if="{{currentView==='driver'}}">ç›®å‰æ˜¾ç¤ºä¸ºæœ€è¿‘ä¸€å‘¨çš„äººæ‰¾è½¦</view>
    <view class="tip-subtext">è¯·é€šè¿‡é¦–é¡µæœç´¢æ¥å¯»æ‰¾ç‰¹å®šçš„éœ€æ±‚</view>
  </view>
</view>
<button class="refresh-btn" bindtap="refreshData">åˆ·æ–°</button>

<!-- ========================== æ‰¾ä¹˜å®¢ ========================== -->
<block wx:if="{{currentView==='passenger'}}">

  <!-- ===== æœç´¢æç¤º ===== -->
  <view wx:if="{{showPassengerSearchPrompt}}" class="search-tip">
    è¯·è¿”å›é¦–é¡µè®¾ç½®æœç´¢æ¡ä»¶
  </view>

  <!-- ===== æ•°æ®ä¸æ’åº ===== -->
  <block wx:else>

    <!-- ---------- æ’åºæ§ä»¶ ---------- -->
    <view class="sort-bar">
      <!-- æ’åºå­—æ®µ -->
      <picker mode="selector"
              range="{{passengerSortFields}}"
              range-key="label"
              value="{{passengerSortFieldIndex}}"
              bindchange="onPassengerSortFieldChange">
        <view class="picker">
          æ’åºå­—æ®µï¼š{{passengerSortFields[passengerSortFieldIndex].label}}
        </view>
      </picker>

      <!-- å‡/é™åº -->
      <picker mode="selector"
              range="{{passengerSortOrderOptions}}"
              range-key="label"
              value="{{passengerSortOrderIndex}}"
              bindchange="onPassengerSortOrderChange">
        <view class="picker">
          {{passengerSortOrderOptions[passengerSortOrderIndex].label}}
        </view>
      </picker>
    </view>

    <!-- ---------- å¡ç‰‡åˆ—è¡¨ ---------- -->
    <block wx:if="{{passengerData.length > 0}}">
      <block wx:for="{{passengerData}}" wx:key="_id">
        <view class="ride-card {{item.isPast?'past':''}}" data-id="{{item._id}}" data-type="{{item.type}}"
              bindtap="chooseItem">
          <!-- header -->
          <view class="ride-header">
            <text class="badge badge-driver">{{item.displayType}}</text>
            <text wx:if="{{item.matchLabel}}" class="match-badge">{{item.matchLabel}}</text>
            <text class="ride-date {{item.isPast?'date-past':''}}">
              {{item.departure_date}} {{item.departure_time||'00:00'}}
            </text>
            <text wx:if="{{item.isPast}}" class="expired-badge">å·²è¿‡æœŸ</text>
          </view>

          <!-- body -->
          <view class="ride-body">
            <view class="row">
              <text>å‡ºå‘åœ°ï¼š</text><text class="bold">{{item.departure_place.city}}, {{item.departure_place.state}}</text>
            </view>
            <view class="row">
              <text>ç›®çš„åœ°ï¼š</text><text class="bold">{{item.arrival_place.city}}, {{item.arrival_place.state}}</text>
            </view>

            <!-- é€”ç»ç‚¹æ˜¾ç¤º -->
            <view wx:if="{{item.stopovers && item.stopovers.length}}" class="stopovers-row">
              <text class="stopovers-label">é€”ç»ï¼š</text>
              <view class="stopovers-list">
                <block wx:for="{{item.stopovers}}" wx:key="index" wx:for-item="stopover">
                  <text class="stopover-item">{{stopover.city}}{{stopover.state ? ', ' + stopover.state : ''}}</text>
                </block>
              </view>
            </view>
            <view class="row">
              <text>ç©ºä½™åº§ä½ï¼š</text><text class="bold">{{item.empty_seats}}</text>
            </view>
            <view class="row">
              <text>ä»·æ ¼ï¼š$</text><text class="bold">{{item.price}}/äºº</text>
            </view>
            <view class="row">
              <text style="font-size:22rpx;color:#999;">åˆ°ç»åœç‚¹ä»·æ ¼éœ€ä¸å¸æœºåå•†</text>
            </view>
          </view>
        </view>
      </block>
    </block>
    
    <!-- æ— ç»“æœæç¤º -->
    <view wx:elif="{{!showPassengerSearchPrompt && passengerData.length === 0}}" class="no-result">
      <view class="no-result-icon">ğŸ”</view>
      <view class="no-result-text">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„é¡ºé£è½¦</view>
      <view class="no-result-subtext">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–é‡æ–°æœç´¢</view>
      <button class="retry-btn" bindtap="retrySearch">é‡æ–°æœç´¢</button>
    </view>
  </block>
</block>

<!-- ========================== æ‰¾å¸æœº ========================== -->
<block wx:elif="{{currentView==='driver'}}">

  <!-- ===== æœç´¢æç¤º ===== -->
  <view wx:if="{{showDriverSearchPrompt}}" class="search-tip">
    è¯·è¿”å›é¦–é¡µè®¾ç½®æœç´¢æ¡ä»¶
  </view>

  <!-- ===== æ•°æ®ä¸æ’åº ===== -->
  <block wx:else>

    <!-- ---------- æ’åºæ§ä»¶ ---------- -->
    <view class="sort-bar">
      <picker mode="selector"
              range="{{driverSortFields}}"
              range-key="label"
              value="{{driverSortFieldIndex}}"
              bindchange="onDriverSortFieldChange">
        <view class="picker">
          æ’åºå­—æ®µï¼š{{driverSortFields[driverSortFieldIndex].label}}
        </view>
      </picker>

      <picker mode="selector"
              range="{{driverSortOrderOptions}}"
              range-key="label"
              value="{{driverSortOrderIndex}}"
              bindchange="onDriverSortOrderChange">
        <view class="picker">
          {{driverSortOrderOptions[driverSortOrderIndex].label}}
        </view>
      </picker>
    </view>

    <!-- ---------- å¡ç‰‡åˆ—è¡¨ ---------- -->
    <block wx:if="{{driverData.length > 0}}">
      <block wx:for="{{driverData}}" wx:key="_id">
        <view class="ride-card {{item.isPast?'past':''}}" data-id="{{item._id}}" data-type="{{item.type}}"
              bindtap="chooseItem">
          <view class="ride-header">
            <text class="badge badge-passenger">{{item.displayType}}</text>
            <text wx:if="{{item.matchLabel}}" class="match-badge">{{item.matchLabel}}</text>
            <text class="ride-date {{item.isPast?'date-past':''}}">
              {{item.departure_date}} {{item.departure_time||'00:00'}}
            </text>
            <text wx:if="{{item.isPast}}" class="expired-badge">å·²è¿‡æœŸ</text>
          </view>

          <view class="ride-body">
            <view class="row">
              <text>å‡ºå‘åœ°ï¼š</text><text class="bold">{{item.departure_place.city}}, {{item.departure_place.state}}</text>
            </view>
            <view class="row">
              <text>ç›®çš„åœ°ï¼š</text><text class="bold">{{item.arrival_place.city}}, {{item.arrival_place.state}}</text>
            </view>
            <!-- é€”ç»ç‚¹æ˜¾ç¤ºï¼ˆè¯·æ±‚ä¹Ÿå¯åŒ…å«ï¼‰ -->
            <view wx:if="{{item.stopovers && item.stopovers.length}}" class="stopovers-row">
              <text class="stopovers-label">é€”ç»ï¼š</text>
              <view class="stopovers-list">
                <block wx:for="{{item.stopovers}}" wx:key="index" wx:for-item="stopover">
                  <text class="stopover-item">{{stopover.city}}</text>
                </block>
              </view>
            </view>
            <view class="row">
              <text>ä¹˜åäººæ•°ï¼š</text><text class="bold">{{item.passenger_number}}</text>
            </view>
            <view class="row">
              <text>æœŸæœ›ä»·æ ¼ï¼š$</text><text class="bold">{{item.price}}/äºº</text>
            </view>
            
            <!-- JoinæŒ‰é’®åŒºåŸŸ -->
            <view class="join-actions" catchtap="handleStopPropagation">
              <!-- è‡ªå·±å‘å¸ƒçš„è¯·æ±‚ -->
              <button wx:if="{{item.isOwnRequest}}" class="join-btn disabled" disabled>
                æˆ‘çš„è¯·æ±‚
              </button>
              <!-- ä»–äººå‘å¸ƒçš„è¯·æ±‚ - æœªåŠ å…¥ -->
              <button wx:elif="{{!item.hasJoined}}" class="join-btn primary" 
                      data-id="{{item._id}}" bindtap="joinRequest">
                åŠ å…¥è¯·æ±‚
              </button>
              <!-- ä»–äººå‘å¸ƒçš„è¯·æ±‚ - å·²åŠ å…¥ -->
              <button wx:else class="join-btn joined" disabled>
                å·²åŠ å…¥
              </button>
            </view>
          </view>
        </view>
      </block>
    </block>
    
    <!-- æ— ç»“æœæç¤º -->
    <view wx:elif="{{!showDriverSearchPrompt && driverData.length === 0}}" class="no-result">
      <view class="no-result-icon">ğŸ”</view>
      <view class="no-result-text">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„ä¹˜å®¢éœ€æ±‚</view>
      <view class="no-result-subtext">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–é‡æ–°æœç´¢</view>
      <button class="retry-btn" bindtap="retrySearch">é‡æ–°æœç´¢</button>
    </view>
  </block>
</block>
