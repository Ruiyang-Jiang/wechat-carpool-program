<!-- 顶部 Tab -->
<view class="tabs">
  <view class="tab {{currentView==='passenger'?'active':''}}" bindtap="gotoFindPassenger">找乘客</view>
  <view class="tab {{currentView==='driver'?'active':''}}"    bindtap="gotoFindDriver">找司机</view>
</view>

<!-- ========================== 找乘客 ========================== -->
<block wx:if="{{currentView==='passenger'}}">

  <!-- ===== 搜索提示 ===== -->
  <view wx:if="{{showPassengerSearchPrompt}}" class="search-tip">
    请返回首页设置搜索条件
  </view>

  <!-- ===== 数据与排序 ===== -->
  <block wx:else>

    <!-- ---------- 排序控件 ---------- -->
    <view class="sort-bar">
      <!-- 排序字段 -->
      <picker mode="selector"
              range="{{passengerSortFields}}"
              range-key="label"
              value="{{passengerSortFieldIndex}}"
              bindchange="onPassengerSortFieldChange">
        <view class="picker">
          排序字段：{{passengerSortFields[passengerSortFieldIndex].label}}
        </view>
      </picker>

      <!-- 升/降序 -->
      <picker mode="selector"
              range="{{passengerSortOrderOptions}}"
              range-key="label"
              value="{{passengerSortOrderIndex}}"
              bindchange="onPassengerSortOrderChange">
        <view class="picker">
          {{passengerSortOrderOptions[passengerSortOrderIndex].label}}
        </view>
      </picker>
    </view>

    <!-- ---------- 卡片列表 ---------- -->
    <block wx:for="{{passengerData}}" wx:key="_id">
      <view class="ride-card {{item.isPast?'past':''}}" data-id="{{item._id}}" data-type="{{item.type}}"
            bindtap="chooseItem">
        <!-- header -->
        <view class="ride-header">
          <text class="badge badge-driver">{{item.displayType}}</text>
          <text wx:if="{{item.matchLabel}}" class="match-badge">{{item.matchLabel}}</text>
          <text class="ride-date {{item.isPast?'date-past':''}}">
            {{item.departure_date}} {{item.departure_time||'00:00'}}
          </text>
          <text wx:if="{{item.isPast}}" class="expired-badge">已过期</text>
        </view>

        <!-- body -->
        <view class="ride-body">
          <view class="row">
            <text>出发地：</text><text class="bold">{{item.departure_place.city}}, {{item.departure_place.state}}</text>
          </view>
          <view class="row">
            <text>目的地：</text><text class="bold">{{item.arrival_place.city}}, {{item.arrival_place.state}}</text>
          </view>

          <!-- 途经点显示 -->
          <view wx:if="{{item.stopovers && item.stopovers.length}}" class="stopovers-row">
            <text class="stopovers-label">途经：</text>
            <view class="stopovers-list">
              <block wx:for="{{item.stopovers}}" wx:key="index" wx:for-item="stopover">
                <text class="stopover-item">{{stopover.city}}{{stopover.state ? ', ' + stopover.state : ''}}</text>
              </block>
            </view>
          </view>
          <view class="row">
            <text>空余座位：</text><text class="bold">{{item.empty_seats}}</text>
          </view>
          <view class="row">
            <text>价格：</text><text class="bold">{{item.price}}</text>
          </view>
          <view class="row">
            <text style="font-size:22rpx;color:#999;">到经停点价格需与司机协商</text>
          </view>
        </view>
      </view>
    </block>
  </block>
</block>

<!-- ========================== 找司机 ========================== -->
<block wx:elif="{{currentView==='driver'}}">

  <!-- ===== 搜索提示 ===== -->
  <view wx:if="{{showDriverSearchPrompt}}" class="search-tip">
    请返回首页设置搜索条件
  </view>

  <!-- ===== 数据与排序 ===== -->
  <block wx:else>

    <!-- ---------- 排序控件 ---------- -->
    <view class="sort-bar">
      <picker mode="selector"
              range="{{driverSortFields}}"
              range-key="label"
              value="{{driverSortFieldIndex}}"
              bindchange="onDriverSortFieldChange">
        <view class="picker">
          排序字段：{{driverSortFields[driverSortFieldIndex].label}}
        </view>
      </picker>

      <picker mode="selector"
              range="{{driverSortOrderOptions}}"
              range-key="label"
              value="{{driverSortOrderIndex}}"
              bindchange="onDriverSortOrderChange">
        <view class="picker">
          {{driverSortOrderOptions[driverSortOrderIndex].label}}
        </view>
      </picker>
    </view>

    <!-- ---------- 卡片列表 ---------- -->
    <block wx:for="{{driverData}}" wx:key="_id">
      <view class="ride-card {{item.isPast?'past':''}}" data-id="{{item._id}}" data-type="{{item.type}}"
            bindtap="chooseItem">
        <view class="ride-header">
          <text class="badge badge-passenger">{{item.displayType}}</text>
          <text wx:if="{{item.matchLabel}}" class="match-badge">{{item.matchLabel}}</text>
          <text class="ride-date {{item.isPast?'date-past':''}}">
            {{item.departure_date}} {{item.departure_time||'00:00'}}
          </text>
          <text wx:if="{{item.isPast}}" class="expired-badge">已过期</text>
        </view>

        <view class="ride-body">
          <view class="row">
            <text>出发地：</text><text class="bold">{{item.departure_place.city}}, {{item.departure_place.state}}</text>
          </view>
          <view class="row">
            <text>目的地：</text><text class="bold">{{item.arrival_place.city}}, {{item.arrival_place.state}}</text>
          </view>
          <!-- 途经点显示（请求也可包含） -->
          <view wx:if="{{item.stopovers && item.stopovers.length}}" class="stopovers-row">
            <text class="stopovers-label">途经：</text>
            <view class="stopovers-list">
              <block wx:for="{{item.stopovers}}" wx:key="index" wx:for-item="stopover">
                <text class="stopover-item">{{stopover.city}}</text>
              </block>
            </view>
          </view>
          <view class="row">
            <text>乘坐人数：</text><text class="bold">{{item.passenger_number}}</text>
          </view>
          <view class="row">
            <text>期望价格：</text><text class="bold">{{item.price}}</text>
          </view>
          
          <!-- Join按钮区域 -->
          <view class="join-actions" catchtap="handleStopPropagation">
            <!-- 自己发布的请求 -->
            <button wx:if="{{item.isOwnRequest}}" class="join-btn disabled" disabled>
              我的请求
            </button>
            <!-- 他人发布的请求 - 未加入 -->
            <button wx:elif="{{!item.hasJoined}}" class="join-btn primary" 
                    data-id="{{item._id}}" bindtap="joinRequest">
              加入请求
            </button>
            <!-- 他人发布的请求 - 已加入 -->
            <button wx:else class="join-btn joined" disabled>
              已加入
            </button>
          </view>
        </view>
      </view>
    </block>
  </block>
</block>
